<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Aflab - How I secured my data on my laptop</title><meta name="gridsome:hash" content="40ddb27da864f49af9fbdeee4ebe42b3ffad8e8a"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/svg+xml" sizes="16x16" href="/assets/static/favicon.ce0531f.e3cf3f092adde90a6cde93c67e825d1d.svg"><link data-vue-tag="ssr" rel="icon" type="image/svg+xml" sizes="32x32" href="/assets/static/favicon.ac8d93a.e3cf3f092adde90a6cde93c67e825d1d.svg"><link rel="preload" href="/assets/css/7.styles.f1c928c6.css" as="style"><link rel="preload" href="/assets/js/app.feb235b1.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--post-vue.1da42f01.js" as="script"><link rel="prefetch" href="/assets/js/page--node-modules--gridsome--app--pages--404-vue.8b43cab5.js"><link rel="prefetch" href="/assets/js/page--src--pages--blog-vue.3923b185.js"><link rel="prefetch" href="/assets/js/page--src--pages--contact-vue.2a74bf89.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.537e089c.js"><link rel="prefetch" href="/assets/js/page--src--pages--rivers-vue.d0bb4c27.js"><link rel="prefetch" href="/assets/js/vendors~page--src--pages--rivers-vue.51994da0.js"><link rel="stylesheet" href="/assets/css/7.styles.f1c928c6.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div data-server-rendered="true" id="app" class="layout"><header class="header"><nav class="navbar navbar-light bg-secondary navbar-expand"><div class="navbar-brand"><a title="Home" href="/" class="logo"><svg viewBox="-28 -14 52 28" xmlns="http://www.w3.org/2000/svg" height="30px" class="logo svg-inline"><path fill="currentColor" d="M 0 0 m -4 0 l -16 0 l 8 -14 Z"></path><path fill="currentColor" d="M 0 0 m 0 7 l -24 0 l -4 7 l 32 0 Z"></path><path fill="currentColor" d="M 0 0 m 4 0 l 16 0 l 4 7 l -8 0 l 4 7 l -8 0 Z"></path><path fill="currentColor" d="M 0 0 m 0 -7 l -4 -7 l 24 0 l 4 7 Z"></path></svg></a></div><div id="nav-collapse" class="navbar-collapse collapse" style="display:none;"><ul class="navbar-nav"><li class="nav-item"><a href="/blog" target="_self" class="nav-link">Blog</a></li><li class="nav-item"><a href="/rivers" target="_self" class="nav-link">4Rivers</a></li></ul><ul class="navbar-nav ml-auto"><li title="Mail" class="nav-item"><a href="mailto:contact@aflab.fr" target="_self" class="nav-link"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="envelope" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-inline--fa fa-envelope fa-w-16"><path fill="currentColor" d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path></svg></a></li><li title="LinkedIn" class="nav-item"><a href="https://www.linkedin.com/in/arthur-f-4660ab214" rel="noopener" target="_blank" class="nav-link"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="svg-inline--fa fa-linkedin fa-w-14"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a></li><li title="Github" class="nav-item"><a href="https://github.com/aflab-dotfr" rel="noopener" target="_blank" class="nav-link"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="svg-inline--fa fa-github fa-w-16"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li></ul></div></nav></header><div class="container-xl pt-4"><div role="alert" aria-live="polite" aria-atomic="true" class="alert alert-warning"><!---->
  Before you read, please be aware that I wrote thoses blog posts for myself as a exercise to help me learn new skills and also improve my english. I wouldn't recommend anyone to actually follow any of this as there's probably a lot of mistakes and it's not very well made.
</div><h1 class="display-4">How I secured my data on my laptop</h1><hr><h6 class="card-subtitle text-muted mb-4"><svg aria-hidden="true" focusable="false" data-prefix="far" data-icon="clock" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-inline--fa fa-clock fa-w-16"><path fill="currentColor" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"></path></svg> 2021.03.19
    <a title="CC BY 4.0" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="creative-commons" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="ml-1 svg-inline--fa fa-creative-commons fa-w-16"><path fill="currentColor" d="M245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93-22.13 0-33.22 14.61-33.22 43.84 0 23.57 9.21 43.84 33.22 43.84 14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98-22.6 0-73.96-10.32-73.96-77.05 0-58.69 43-77.06 72.63-77.06 30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93-22.14 0-33.22 14.61-33.22 43.84 0 23.55 9.23 43.84 33.22 43.84 14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98-22.69 0-73.96-9.87-73.96-77.05 0-58.67 42.97-77.06 72.63-77.06 30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248 129.93 0 248.44-100.87 248.44-248 0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81 0-105.42 85.43-203.27 203.72-203.27 112.53 0 202.82 89.46 202.82 203.26-.01 121.69-99.68 202.82-202.84 202.82z"></path></svg><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="creative-commons-by" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="ml-1 svg-inline--fa fa-creative-commons-by fa-w-16"><path fill="currentColor" d="M314.9 194.4v101.4h-28.3v120.5h-77.1V295.9h-28.3V194.4c0-4.4 1.6-8.2 4.6-11.3 3.1-3.1 6.9-4.7 11.3-4.7H299c4.1 0 7.8 1.6 11.1 4.7 3.1 3.2 4.8 6.9 4.8 11.3zm-101.5-63.7c0-23.3 11.5-35 34.5-35s34.5 11.7 34.5 35c0 23-11.5 34.5-34.5 34.5s-34.5-11.5-34.5-34.5zM247.6 8C389.4 8 496 118.1 496 256c0 147.1-118.5 248-248.4 248C113.6 504 0 394.5 0 256 0 123.1 104.7 8 247.6 8zm.8 44.7C130.2 52.7 44.7 150.6 44.7 256c0 109.8 91.2 202.8 203.7 202.8 103.2 0 202.8-81.1 202.8-202.8.1-113.8-90.2-203.3-202.8-203.3z"></path></svg></a></h6><p class="lead mb-5 text-justify">By encrypting the root partition, detaching the LUKS header into a USB key, signing my own UEFI kernel, enabling secure boot, booting directly from firmware without any bootloader and locking the BIOS setup interface behind a password.</p><article class="markdown"><!-- TOC -->
<ul>
<li>
<p><a href="#introduction">Introduction</a></p>
<ul>
<li><a href="#credits-and-sources">Credits and sources</a></li>
</ul>
</li>
<li>
<p><a href="#root-encryption">Root encryption</a></p>
<ul>
<li><a href="#create-a-new-partition-table">Create a new partition table</a></li>
<li><a href="#setup-luks">Setup LUKS</a></li>
<li><a href="#format-both-partitions">Format both partitions</a></li>
<li><a href="#overwrite-previous-data">Overwrite previous data</a></li>
<li><a href="#decrypt-partition-at-boot">Decrypt partition at boot</a></li>
</ul>
</li>
<li>
<p><a href="#secure-boot">Secure boot</a></p>
<ul>
<li><a href="#generate-your-own-keys">Generate your own keys</a></li>
<li><a href="#generate-signed-unified-kernel">Generate signed unified kernel</a></li>
<li><a href="#enroll-keys-in-firmware">Enroll keys in firmware</a></li>
<li><a href="#bootloader">Bootloader</a></li>
</ul>
</li>
<li><a href="#recommendations">Recommendations</a></li>
</ul>
<!-- /TOC -->
<h1 id="introduction"><a href="#introduction" aria-hidden="true"><span class="icon icon-link"></span></a>Introduction</h1>
<p>Why ? You may ask. If like me, you like to work on your laptop from different places, then you may want to make sure that your sensitives data stay protected in case someone as a physical access to your computer.</p>
<p>I'm not an expert in computer security. So please, be aware that my solution is not perfect and many vulnerabilities could still be exploited. Also, there's many different way to achieve this but I'll focus on only one method to avoid confusion.</p>
<p>I have a 5 years old Dell XPS 15 and I'm using Arch Linux. It should works with another GNU/Linux distribution as the features used are mainly kernel related and the other packages are pretty common. However, the computer need to support EFI secure boot and being able to lock the BIOS setup interface behind a password.</p>
<h2 id="credits-and-sources"><a href="#credits-and-sources" aria-hidden="true"><span class="icon icon-link"></span></a>Credits and sources</h2>
<ul>
<li><a href="https://wiki.archlinux.org/index.php/Installation_guide" target="_blank" rel="nofollow noopener noreferrer">ArchLinux Wiki: Installation guide</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Dm-crypt/Encrypting_an_entire_system#LUKS_on_LVM" target="_blank" rel="nofollow noopener noreferrer">ArchLinux Wiki: Dm-crypt/LUKS on LVM</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Unified_Extensible_Firmware_Interface/Secure_Boot" target="_blank" rel="nofollow noopener noreferrer">ArchLinux Wiki: Unified Extensible Firmware Interface/Secure Boot</a></li>
<li><a href="https://bentley.link/secureboot/" target="_blank" rel="nofollow noopener noreferrer">Matthew Bently: Combine the kernel, initramfs, and boot options</a></li>
</ul>
<h1 id="root-encryption"><a href="#root-encryption" aria-hidden="true"><span class="icon icon-link"></span></a>Root encryption</h1>
<p>Don't forget to verify the signature of your installation image as to avoid any malware from the start, then proceed with the <a href="https://wiki.archlinux.org/index.php/Installation_guide" target="_blank" rel="nofollow noopener noreferrer">installation</a> normally until you need to prepare your disk.</p>
<h2 id="create-a-new-partition-table"><a href="#create-a-new-partition-table" aria-hidden="true"><span class="icon icon-link"></span></a>Create a new partition table</h2>
<p>Using <a href="https://wiki.archlinux.org/index.php/Fdisk" target="_blank" rel="nofollow noopener noreferrer"><em>fdisk</em></a>, look for the name of your disk.</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">fdisk</span> -l</code></pre>
<p>In my case, having a NVMe SSD, my disk is named <strong>nvme0n1</strong> but otherwise, it's commonly named <strong>sda</strong>.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Type</th>
<th>Size</th>
</tr>
</thead>
<tbody>
<tr>
<td>/dev/sda1</td>
<td>EFI</td>
<td>512MB</td>
</tr>
<tr>
<td>/dev/sda2</td>
<td>Linux filesystem</td>
<td>Remainder of the device</td>
</tr>
</tbody>
</table>
<p>That's how the partition table will look like if you follow my example. Normally, I like to use LVM as it offers more flexibility but I removed it to simplify. Also, I don't have a swap partition.</p>
<p>Start <em>fdisk</em>.</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">fdisk</span> /dev/sda</code></pre>
<p>Inside the prompt:</p>
<ol>
<li>Type <strong>g</strong> to create a new empty GPT partition table.</li>
<li>Type <strong>n</strong> to add a first partition.</li>
<li>Type <strong>Enter</strong> a first time to accept the default partition number, then <strong>Enter</strong> a second time to accept the default first sector and finally <strong>+512M</strong> for the last sector.</li>
<li>Type <strong>t</strong> then <strong>efi</strong> to change the type to 'EFI system'.</li>
<li>Type <strong>n</strong> to add a second partition.</li>
<li>Type <strong>Enter</strong> 3 times to accept all default values.</li>
<li>Type <strong>w</strong> to save the changes and exit.</li>
</ol>
<h2 id="setup-luks"><a href="#setup-luks" aria-hidden="true"><span class="icon icon-link"></span></a>Setup LUKS</h2>
<p>I chose to detach the header into a USB key as a simple way to get a physical authentication factor. If your passphrase somehow leaked, your partition cannot be decrypted without the salt contained in the header. Also, even if someone had the computational power to break the encryption, it would make the process a bit harder.</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">mount</span> /dev/sdb1 /mnt <span class="token comment"># mount the usb</span>
cryptsetup luksFormat /dev/sda2 --header /mnt/header.img
cryptsetup <span class="token function">open</span> /dev/sda2 root --header /mnt/header.img
<span class="token function">umount</span> /mnt</code></pre>
<p>I strongly recommend making a backup of the header file somewhere safe. You cannot decrypt the root partition without it. So if your USB key fails, you'll lose all your data.</p>
<h2 id="format-both-partitions"><a href="#format-both-partitions" aria-hidden="true"><span class="icon icon-link"></span></a>Format both partitions</h2>
<pre class="language-shell"><code class="language-shell">mkfs.vfat -F32 /dev/sda1
mkfs.ext4 /dev/mapper/root</code></pre>
<h2 id="overwrite-previous-data"><a href="#overwrite-previous-data" aria-hidden="true"><span class="icon icon-link"></span></a>Overwrite previous data</h2>
<p>This is a very long process depending of the size of your partition. If you don't do this, some old data could still be potentially retrieved.</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/dev/mapper/root <span class="token assign-left variable">status</span><span class="token operator">=</span>progress</code></pre>
<p>No need to use <code>/dev/random</code> because the encryption already turn the zeroes into random data.</p>
<p><strong>Proceed with the rest of the installation and chroot into your new installation. Don't install any bootloader, the kernel will boot directly from the firmware.</strong></p>
<h2 id="decrypt-partition-at-boot"><a href="#decrypt-partition-at-boot" aria-hidden="true"><span class="icon icon-link"></span></a>Decrypt partition at boot</h2>
<p>In order to decrypt your root partition at boot with a detached LUKS header on a usb key, add a custom hook to <em>initcpio</em>.</p>
<p>I chose to use labels instead of GUIDs so I can use a backup USB key if the main one fails. So be aware that if there's another external drive connected to your laptop while booting, you may not be able to decrypt your root partition because of that.</p>
<p><code>/etc/initcpio/hooks/customencrypt</code></p>
<pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/ash</span>

<span class="token function-name function">run_hook</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    modprobe -a -q dm-crypt <span class="token operator">></span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span>

    <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -b <span class="token string">'/dev/sdb1'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
     <span class="token function">sleep</span> <span class="token number">1</span>
    <span class="token keyword">done</span>

    <span class="token function">mkdir</span> -p /mnt
    <span class="token function">mount</span> /dev/sdb1 /mnt
    cryptsetup --header /mnt/header.img <span class="token function">open</span> /dev/sda2 root
    <span class="token function">umount</span> /mnt
<span class="token punctuation">}</span></code></pre>
<p><code>/etc/initcpio/install/customencrypt</code></p>
<pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token function-name function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin class-name">local</span> mod

    add_module <span class="token string">"dm-crypt"</span>
    add_module <span class="token string">"dm-integrity"</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$CRYPTO_MODULES</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">for</span> <span class="token for-or-select variable">mod</span> <span class="token keyword">in</span> <span class="token variable">$CRYPTO_MODULES</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
            add_module <span class="token string">"<span class="token variable">$mod</span>"</span>
        <span class="token keyword">done</span>
    <span class="token keyword">else</span>
        add_all_modules <span class="token string">"/crypto/"</span>
    <span class="token keyword">fi</span>

    add_binary <span class="token string">"cryptsetup"</span>
    add_binary <span class="token string">"dmsetup"</span>
    add_file <span class="token string">"/usr/lib/udev/rules.d/10-dm.rules"</span>
    add_file <span class="token string">"/usr/lib/udev/rules.d/13-dm-disk.rules"</span>
    add_file <span class="token string">"/usr/lib/udev/rules.d/95-dm-notify.rules"</span>
    add_file <span class="token string">"/usr/lib/initcpio/udev/11-dm-initramfs.rules"</span> <span class="token string">"/usr/lib/udev/rules.d/11-dm-initramfs.rules"</span>

    <span class="token comment"># cryptsetup calls pthread_create(), which dlopen()s libgcc_s.so.1</span>
    add_binary <span class="token string">"/usr/lib/libgcc_s.so.1"</span>

    add_runscript
<span class="token punctuation">}</span></code></pre>
<p>And finally, modify your <em>mkinitcpio</em> configuration file to add the custom module.</p>
<p><code>/etc/mkinitcpio.conf</code></p>
<pre class="language-text"><code class="language-text">HOOKS=(base udev autodetect keyboard keymap modconf block filesystems fsck customencrypt)</code></pre>
<p>Use this mkinitcpio command to create your new initial ramdisk image.</p>
<pre class="language-shell"><code class="language-shell">mkinitcpio -P</code></pre>
<h1 id="secure-boot"><a href="#secure-boot" aria-hidden="true"><span class="icon icon-link"></span></a>Secure boot</h1>
<p>Why going through the hassle of enabling secure boot ? Well, your root partition is safe but your kernel is not. Imagine you let your laptop unsupervised a few minutes, someone could boot from a usb and replace your kernel with a custom one without you noticing. It's something you really don't want and I don't really need to explain why.</p>
<p>Install the <em>sbsigntools</em> package.</p>
<pre class="language-shell"><code class="language-shell">pacman -S sbsigntools</code></pre>
<p>Create a new directory in a secure location like <code>/root/secureboot</code>.</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">mkdir</span> /root/secureboot
<span class="token builtin class-name">cd</span> /root/secureboot</code></pre>
<h2 id="generate-your-own-keys"><a href="#generate-your-own-keys" aria-hidden="true"><span class="icon icon-link"></span></a>Generate your own keys</h2>
<p>Create a script named <code>mkkeys.sh</code> that will automate the process.</p>
<pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token builtin class-name">echo</span> -n <span class="token string">"Enter a Common Name to embed in the keys: "</span>
<span class="token builtin class-name">read</span> name

<span class="token comment">#GUID</span>
uuidgen --random <span class="token operator">></span> GUID.txt

<span class="token comment">#PLATFORM KEY</span>
openssl req -newkey rsa:4096 -nodes -keyout PK.key -new -x509 -sha256 -days <span class="token number">3650</span> -subj <span class="token string">"/CN=<span class="token variable">$name</span> PK/"</span> -out PK.crt
openssl x509 -outform DER -in PK.crt -out PK.cer
cert-to-efi-sig-list -g <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token operator">&lt;</span> GUID.txt<span class="token variable">)</span></span>"</span> PK.crt PK.esl
sign-efi-sig-list -g <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token operator">&lt;</span> GUID.txt<span class="token variable">)</span></span>"</span> -k PK.key -c PK.crt PK PK.esl PK.auth
sign-efi-sig-list -g <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token operator">&lt;</span> GUID.txt<span class="token variable">)</span></span>"</span> -c PK.crt -k PK.key PK /dev/null rm_PK.auth

<span class="token comment">#KEY EXCHANGE KEY</span>
openssl req -newkey rsa:4096 -nodes -keyout KEK.key -new -x509 -sha256 -days <span class="token number">3650</span> -subj <span class="token string">"/CN=<span class="token variable">$name</span> KEK/"</span> -out KEK.crt
openssl x509 -outform DER -in KEK.crt -out KEK.cer
cert-to-efi-sig-list -g <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token operator">&lt;</span> GUID.txt<span class="token variable">)</span></span>"</span> KEK.crt KEK.esl
sign-efi-sig-list -g <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token operator">&lt;</span> GUID.txt<span class="token variable">)</span></span>"</span> -k PK.key -c PK.crt KEK KEK.esl KEK.auth

<span class="token comment">#SIGNATURE DATABASE KEY</span>
openssl req -newkey rsa:4096 -nodes -keyout db.key -new -x509 -sha256 -days <span class="token number">3650</span> -subj <span class="token string">"/CN=<span class="token variable">$name</span> db/"</span> -out db.crt
openssl x509 -outform DER -in db.crt -out db.cer
cert-to-efi-sig-list -g <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token operator">&lt;</span> GUID.txt<span class="token variable">)</span></span>"</span> db.crt db.esl
sign-efi-sig-list -g <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token operator">&lt;</span> GUID.txt<span class="token variable">)</span></span>"</span> -k KEK.key -c KEK.crt db db.esl db.auth</code></pre>
<p>Then execute the script.</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">touch</span> mkkeys.sh
<span class="token function">chmod</span> +x mkkeys.sh
./mkkeys.sh</code></pre>
<h2 id="generate-signed-unified-kernel"><a href="#generate-signed-unified-kernel" aria-hidden="true"><span class="icon icon-link"></span></a>Generate signed unified kernel</h2>
<p>Create a file named <code>cmdline.txt</code> containing the kernel parameters.</p>
<pre class="language-shell"><code class="language-shell"><span class="token assign-left variable">BOOT_IMAGE</span><span class="token operator">=</span>/vmlinuz-linux <span class="token assign-left variable">initrd</span><span class="token operator">=</span>/intel-ucode.img <span class="token assign-left variable">initrd</span><span class="token operator">=</span>/initramfs-linux.img <span class="token assign-left variable">root</span><span class="token operator">=</span>/dev/mapper/root</code></pre>
<p>Notice that I'm using the <a href="https://wiki.archlinux.org/index.php/Microcode#Installation" target="_blank" rel="nofollow noopener noreferrer">Intel microcode</a>. If you don't have a Intel CPU or just don't want to use it, some modifications are required.</p>
<p>Create a script named <code>mkkernel.sh</code>.</p>
<pre class="language-shell"><code class="language-shell"><span class="token shebang important">#!/bin/sh</span>
<span class="token builtin class-name">cd</span> /root/secureboot

<span class="token comment">#COMBINE FILES</span>
<span class="token function">cat</span> /boot/intel-ucode.img /boot/initramfs-linux.img <span class="token operator">></span> initramfs-linux.img
<span class="token function">cp</span> /boot/vmlinuz-linux <span class="token builtin class-name">.</span>

objcopy <span class="token punctuation">\</span>
    --add-section .osrel<span class="token operator">=</span>/etc/os-release --change-section-vma .osrel<span class="token operator">=</span>0x20000 <span class="token punctuation">\</span>
    --add-section .cmdline<span class="token operator">=</span><span class="token string">"cmdline.txt"</span> --change-section-vma .cmdline<span class="token operator">=</span>0x30000 <span class="token punctuation">\</span>
    --add-section .linux<span class="token operator">=</span><span class="token string">"vmlinuz-linux"</span> --change-section-vma .linux<span class="token operator">=</span>0x40000 <span class="token punctuation">\</span>
    --add-section .initrd<span class="token operator">=</span><span class="token string">"initramfs-linux.img"</span> --change-section-vma .initrd<span class="token operator">=</span>0x3000000 <span class="token punctuation">\</span>
    /usr/lib/systemd/boot/efi/linuxx64.efi.stub kernel.efi

<span class="token comment">#SIGN EFI</span>
sbsign --key db.key --cert db.crt --output kernel.efi.signed kernel.efi

<span class="token comment">#COPY KERNEL</span>
<span class="token function">cp</span> kernel.efi.signed /boot/kernel.efi</code></pre>
<p>Make it executable.</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">touch</span> mkkernel.sh
<span class="token function">chmod</span> +x mkkernel.sh</code></pre>
<p>You can manually execute the script each time you want to update the kernel but I recommend to automate the process with a pacman hook.</p>
<p>Create a file at <code>/etc/pacman.d/hooks/91-secureboot.hook</code>.</p>
<pre class="language-text"><code class="language-text">[Trigger]
Type = Path
Operation = Install
Operation = Upgrade
Target = usr/lib/modules/*/vmlinuz
Target = usr/lib/initcpio/*

[Action]
Description = Making signed kernel UEFI
When = PostTransaction
Exec = /root/secureboot/mkkernel.sh
NeedsTargets</code></pre>
<h2 id="enroll-keys-in-firmware"><a href="#enroll-keys-in-firmware" aria-hidden="true"><span class="icon icon-link"></span></a>Enroll keys in firmware</h2>
<p>I tried to use <strong>sbkeysync</strong> but despite being in setup mode, I was unable to enroll my keys so I had to enroll them manually, using my BIOS setup interface. Don't forget to enable secure boot mode in your BIOS setup interface and to lock it behind a password because if someone is able to simply turn it off, it would make all this pointless.</p>
<h2 id="bootloader"><a href="#bootloader" aria-hidden="true"><span class="icon icon-link"></span></a>Bootloader</h2>
<p>I did not install any bootloader because it's simply useless in this case. Instead go into your BIOS setup interface and make a new boot entry for <code>kernel.efi</code>.</p>
<h1 id="recommendations"><a href="#recommendations" aria-hidden="true"><span class="icon icon-link"></span></a>Recommendations</h1>
<ul>
<li>I like to use a passphrase instead of password. It may be a bit longer to enter each time but it's easier to remember and save you the trouble of having to distinguish similar letters. Also a 8 word passphrase from a dictionary of 3600 words is stronger than a 8 long password from 60 different characters (3600^8 > 60^8).</li>
<li>Use a idle screen locker and always lock your laptop before leaving it.</li>
<li>Be aware of who might be looking at your screen/keyboard while you enter your passphrase.</li>
<li>Don't let the usb key containing the LUKS header on your laptop. Remove it after the boot process and keep it with you.</li>
</ul>
</article></div><footer class="m-5"></footer></div>
    <script>window.__INITIAL_STATE__={"data":{"post":{"title":"How I secured my data on my laptop","date":"2021.03.19","description":"By encrypting the root partition, detaching the LUKS header into a USB key, signing my own UEFI kernel, enabling secure boot, booting directly from firmware without any bootloader and locking the BIOS setup interface behind a password.","content":"\u003C!-- TOC --\u003E\n\u003Cul\u003E\n\u003Cli\u003E\n\u003Cp\u003E\u003Ca href=\"#introduction\"\u003EIntroduction\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Ca href=\"#credits-and-sources\"\u003ECredits and sources\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Cp\u003E\u003Ca href=\"#root-encryption\"\u003ERoot encryption\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Ca href=\"#create-a-new-partition-table\"\u003ECreate a new partition table\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"#setup-luks\"\u003ESetup LUKS\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"#format-both-partitions\"\u003EFormat both partitions\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"#overwrite-previous-data\"\u003EOverwrite previous data\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"#decrypt-partition-at-boot\"\u003EDecrypt partition at boot\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Cp\u003E\u003Ca href=\"#secure-boot\"\u003ESecure boot\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Ca href=\"#generate-your-own-keys\"\u003EGenerate your own keys\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"#generate-signed-unified-kernel\"\u003EGenerate signed unified kernel\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"#enroll-keys-in-firmware\"\u003EEnroll keys in firmware\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"#bootloader\"\u003EBootloader\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"#recommendations\"\u003ERecommendations\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003C!-- \u002FTOC --\u003E\n\u003Ch1 id=\"introduction\"\u003E\u003Ca href=\"#introduction\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EIntroduction\u003C\u002Fh1\u003E\n\u003Cp\u003EWhy ? You may ask. If like me, you like to work on your laptop from different places, then you may want to make sure that your sensitives data stay protected in case someone as a physical access to your computer.\u003C\u002Fp\u003E\n\u003Cp\u003EI'm not an expert in computer security. So please, be aware that my solution is not perfect and many vulnerabilities could still be exploited. Also, there's many different way to achieve this but I'll focus on only one method to avoid confusion.\u003C\u002Fp\u003E\n\u003Cp\u003EI have a 5 years old Dell XPS 15 and I'm using Arch Linux. It should works with another GNU\u002FLinux distribution as the features used are mainly kernel related and the other packages are pretty common. However, the computer need to support EFI secure boot and being able to lock the BIOS setup interface behind a password.\u003C\u002Fp\u003E\n\u003Ch2 id=\"credits-and-sources\"\u003E\u003Ca href=\"#credits-and-sources\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003ECredits and sources\u003C\u002Fh2\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fwiki.archlinux.org\u002Findex.php\u002FInstallation_guide\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003EArchLinux Wiki: Installation guide\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fwiki.archlinux.org\u002Findex.php\u002FDm-crypt\u002FEncrypting_an_entire_system#LUKS_on_LVM\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003EArchLinux Wiki: Dm-crypt\u002FLUKS on LVM\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fwiki.archlinux.org\u002Findex.php\u002FUnified_Extensible_Firmware_Interface\u002FSecure_Boot\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003EArchLinux Wiki: Unified Extensible Firmware Interface\u002FSecure Boot\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fbentley.link\u002Fsecureboot\u002F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003EMatthew Bently: Combine the kernel, initramfs, and boot options\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Ch1 id=\"root-encryption\"\u003E\u003Ca href=\"#root-encryption\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003ERoot encryption\u003C\u002Fh1\u003E\n\u003Cp\u003EDon't forget to verify the signature of your installation image as to avoid any malware from the start, then proceed with the \u003Ca href=\"https:\u002F\u002Fwiki.archlinux.org\u002Findex.php\u002FInstallation_guide\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Einstallation\u003C\u002Fa\u003E normally until you need to prepare your disk.\u003C\u002Fp\u003E\n\u003Ch2 id=\"create-a-new-partition-table\"\u003E\u003Ca href=\"#create-a-new-partition-table\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003ECreate a new partition table\u003C\u002Fh2\u003E\n\u003Cp\u003EUsing \u003Ca href=\"https:\u002F\u002Fwiki.archlinux.org\u002Findex.php\u002FFdisk\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003E\u003Cem\u003Efdisk\u003C\u002Fem\u003E\u003C\u002Fa\u003E, look for the name of your disk.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Efdisk\u003C\u002Fspan\u003E -l\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EIn my case, having a NVMe SSD, my disk is named \u003Cstrong\u003Envme0n1\u003C\u002Fstrong\u003E but otherwise, it's commonly named \u003Cstrong\u003Esda\u003C\u002Fstrong\u003E.\u003C\u002Fp\u003E\n\u003Ctable\u003E\n\u003Cthead\u003E\n\u003Ctr\u003E\n\u003Cth\u003EName\u003C\u002Fth\u003E\n\u003Cth\u003EType\u003C\u002Fth\u003E\n\u003Cth\u003ESize\u003C\u002Fth\u003E\n\u003C\u002Ftr\u003E\n\u003C\u002Fthead\u003E\n\u003Ctbody\u003E\n\u003Ctr\u003E\n\u003Ctd\u003E\u002Fdev\u002Fsda1\u003C\u002Ftd\u003E\n\u003Ctd\u003EEFI\u003C\u002Ftd\u003E\n\u003Ctd\u003E512MB\u003C\u002Ftd\u003E\n\u003C\u002Ftr\u003E\n\u003Ctr\u003E\n\u003Ctd\u003E\u002Fdev\u002Fsda2\u003C\u002Ftd\u003E\n\u003Ctd\u003ELinux filesystem\u003C\u002Ftd\u003E\n\u003Ctd\u003ERemainder of the device\u003C\u002Ftd\u003E\n\u003C\u002Ftr\u003E\n\u003C\u002Ftbody\u003E\n\u003C\u002Ftable\u003E\n\u003Cp\u003EThat's how the partition table will look like if you follow my example. Normally, I like to use LVM as it offers more flexibility but I removed it to simplify. Also, I don't have a swap partition.\u003C\u002Fp\u003E\n\u003Cp\u003EStart \u003Cem\u003Efdisk\u003C\u002Fem\u003E.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Efdisk\u003C\u002Fspan\u003E \u002Fdev\u002Fsda\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EInside the prompt:\u003C\u002Fp\u003E\n\u003Col\u003E\n\u003Cli\u003EType \u003Cstrong\u003Eg\u003C\u002Fstrong\u003E to create a new empty GPT partition table.\u003C\u002Fli\u003E\n\u003Cli\u003EType \u003Cstrong\u003En\u003C\u002Fstrong\u003E to add a first partition.\u003C\u002Fli\u003E\n\u003Cli\u003EType \u003Cstrong\u003EEnter\u003C\u002Fstrong\u003E a first time to accept the default partition number, then \u003Cstrong\u003EEnter\u003C\u002Fstrong\u003E a second time to accept the default first sector and finally \u003Cstrong\u003E+512M\u003C\u002Fstrong\u003E for the last sector.\u003C\u002Fli\u003E\n\u003Cli\u003EType \u003Cstrong\u003Et\u003C\u002Fstrong\u003E then \u003Cstrong\u003Eefi\u003C\u002Fstrong\u003E to change the type to 'EFI system'.\u003C\u002Fli\u003E\n\u003Cli\u003EType \u003Cstrong\u003En\u003C\u002Fstrong\u003E to add a second partition.\u003C\u002Fli\u003E\n\u003Cli\u003EType \u003Cstrong\u003EEnter\u003C\u002Fstrong\u003E 3 times to accept all default values.\u003C\u002Fli\u003E\n\u003Cli\u003EType \u003Cstrong\u003Ew\u003C\u002Fstrong\u003E to save the changes and exit.\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\u003Ch2 id=\"setup-luks\"\u003E\u003Ca href=\"#setup-luks\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003ESetup LUKS\u003C\u002Fh2\u003E\n\u003Cp\u003EI chose to detach the header into a USB key as a simple way to get a physical authentication factor. If your passphrase somehow leaked, your partition cannot be decrypted without the salt contained in the header. Also, even if someone had the computational power to break the encryption, it would make the process a bit harder.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Emount\u003C\u002Fspan\u003E \u002Fdev\u002Fsdb1 \u002Fmnt \u003Cspan class=\"token comment\"\u003E# mount the usb\u003C\u002Fspan\u003E\ncryptsetup luksFormat \u002Fdev\u002Fsda2 --header \u002Fmnt\u002Fheader.img\ncryptsetup \u003Cspan class=\"token function\"\u003Eopen\u003C\u002Fspan\u003E \u002Fdev\u002Fsda2 root --header \u002Fmnt\u002Fheader.img\n\u003Cspan class=\"token function\"\u003Eumount\u003C\u002Fspan\u003E \u002Fmnt\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EI strongly recommend making a backup of the header file somewhere safe. You cannot decrypt the root partition without it. So if your USB key fails, you'll lose all your data.\u003C\u002Fp\u003E\n\u003Ch2 id=\"format-both-partitions\"\u003E\u003Ca href=\"#format-both-partitions\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EFormat both partitions\u003C\u002Fh2\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003Emkfs.vfat -F32 \u002Fdev\u002Fsda1\nmkfs.ext4 \u002Fdev\u002Fmapper\u002Froot\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch2 id=\"overwrite-previous-data\"\u003E\u003Ca href=\"#overwrite-previous-data\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EOverwrite previous data\u003C\u002Fh2\u003E\n\u003Cp\u003EThis is a very long process depending of the size of your partition. If you don't do this, some old data could still be potentially retrieved.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Edd\u003C\u002Fspan\u003E \u003Cspan class=\"token assign-left variable\"\u003Eif\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u002Fdev\u002Fzero \u003Cspan class=\"token assign-left variable\"\u003Eof\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u002Fdev\u002Fmapper\u002Froot \u003Cspan class=\"token assign-left variable\"\u003Estatus\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003Eprogress\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ENo need to use \u003Ccode\u003E\u002Fdev\u002Frandom\u003C\u002Fcode\u003E because the encryption already turn the zeroes into random data.\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cstrong\u003EProceed with the rest of the installation and chroot into your new installation. Don't install any bootloader, the kernel will boot directly from the firmware.\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\n\u003Ch2 id=\"decrypt-partition-at-boot\"\u003E\u003Ca href=\"#decrypt-partition-at-boot\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EDecrypt partition at boot\u003C\u002Fh2\u003E\n\u003Cp\u003EIn order to decrypt your root partition at boot with a detached LUKS header on a usb key, add a custom hook to \u003Cem\u003Einitcpio\u003C\u002Fem\u003E.\u003C\u002Fp\u003E\n\u003Cp\u003EI chose to use labels instead of GUIDs so I can use a backup USB key if the main one fails. So be aware that if there's another external drive connected to your laptop while booting, you may not be able to decrypt your root partition because of that.\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode\u003E\u002Fetc\u002Finitcpio\u002Fhooks\u002Fcustomencrypt\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cpre class=\"language-bash\"\u003E\u003Ccode class=\"language-bash\"\u003E\u003Cspan class=\"token shebang important\"\u003E#!\u002Fusr\u002Fbin\u002Fash\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"token function-name function\"\u003Erun_hook\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    modprobe -a -q dm-crypt \u003Cspan class=\"token operator\"\u003E\u003E\u003C\u002Fspan\u003E\u002Fdev\u002Fnull \u003Cspan class=\"token operator\"\u003E\u003Cspan class=\"token file-descriptor important\"\u003E2\u003C\u002Fspan\u003E\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"token file-descriptor important\"\u003E&amp;1\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"token keyword\"\u003Ewhile\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E!\u003C\u002Fspan\u003E -b \u003Cspan class=\"token string\"\u003E'\u002Fdev\u002Fsdb1'\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Edo\u003C\u002Fspan\u003E\n     \u003Cspan class=\"token function\"\u003Esleep\u003C\u002Fspan\u003E \u003Cspan class=\"token number\"\u003E1\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Edone\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"token function\"\u003Emkdir\u003C\u002Fspan\u003E -p \u002Fmnt\n    \u003Cspan class=\"token function\"\u003Emount\u003C\u002Fspan\u003E \u002Fdev\u002Fsdb1 \u002Fmnt\n    cryptsetup --header \u002Fmnt\u002Fheader.img \u003Cspan class=\"token function\"\u003Eopen\u003C\u002Fspan\u003E \u002Fdev\u002Fsda2 root\n    \u003Cspan class=\"token function\"\u003Eumount\u003C\u002Fspan\u003E \u002Fmnt\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Ccode\u003E\u002Fetc\u002Finitcpio\u002Finstall\u002Fcustomencrypt\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cpre class=\"language-bash\"\u003E\u003Ccode class=\"language-bash\"\u003E\u003Cspan class=\"token shebang important\"\u003E#!\u002Fbin\u002Fbash\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"token function-name function\"\u003Ebuild\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token builtin class-name\"\u003Elocal\u003C\u002Fspan\u003E mod\n\n    add_module \u003Cspan class=\"token string\"\u003E\"dm-crypt\"\u003C\u002Fspan\u003E\n    add_module \u003Cspan class=\"token string\"\u003E\"dm-integrity\"\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003E \u003Cspan class=\"token variable\"\u003E$CRYPTO_MODULES\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Ethen\u003C\u002Fspan\u003E\n        \u003Cspan class=\"token keyword\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"token for-or-select variable\"\u003Emod\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Ein\u003C\u002Fspan\u003E \u003Cspan class=\"token variable\"\u003E$CRYPTO_MODULES\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Edo\u003C\u002Fspan\u003E\n            add_module \u003Cspan class=\"token string\"\u003E\"\u003Cspan class=\"token variable\"\u003E$mod\u003C\u002Fspan\u003E\"\u003C\u002Fspan\u003E\n        \u003Cspan class=\"token keyword\"\u003Edone\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Eelse\u003C\u002Fspan\u003E\n        add_all_modules \u003Cspan class=\"token string\"\u003E\"\u002Fcrypto\u002F\"\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Efi\u003C\u002Fspan\u003E\n\n    add_binary \u003Cspan class=\"token string\"\u003E\"cryptsetup\"\u003C\u002Fspan\u003E\n    add_binary \u003Cspan class=\"token string\"\u003E\"dmsetup\"\u003C\u002Fspan\u003E\n    add_file \u003Cspan class=\"token string\"\u003E\"\u002Fusr\u002Flib\u002Fudev\u002Frules.d\u002F10-dm.rules\"\u003C\u002Fspan\u003E\n    add_file \u003Cspan class=\"token string\"\u003E\"\u002Fusr\u002Flib\u002Fudev\u002Frules.d\u002F13-dm-disk.rules\"\u003C\u002Fspan\u003E\n    add_file \u003Cspan class=\"token string\"\u003E\"\u002Fusr\u002Flib\u002Fudev\u002Frules.d\u002F95-dm-notify.rules\"\u003C\u002Fspan\u003E\n    add_file \u003Cspan class=\"token string\"\u003E\"\u002Fusr\u002Flib\u002Finitcpio\u002Fudev\u002F11-dm-initramfs.rules\"\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E\"\u002Fusr\u002Flib\u002Fudev\u002Frules.d\u002F11-dm-initramfs.rules\"\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"token comment\"\u003E# cryptsetup calls pthread_create(), which dlopen()s libgcc_s.so.1\u003C\u002Fspan\u003E\n    add_binary \u003Cspan class=\"token string\"\u003E\"\u002Fusr\u002Flib\u002Flibgcc_s.so.1\"\u003C\u002Fspan\u003E\n\n    add_runscript\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EAnd finally, modify your \u003Cem\u003Emkinitcpio\u003C\u002Fem\u003E configuration file to add the custom module.\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode\u003E\u002Fetc\u002Fmkinitcpio.conf\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003EHOOKS=(base udev autodetect keyboard keymap modconf block filesystems fsck customencrypt)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EUse this mkinitcpio command to create your new initial ramdisk image.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003Emkinitcpio -P\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch1 id=\"secure-boot\"\u003E\u003Ca href=\"#secure-boot\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003ESecure boot\u003C\u002Fh1\u003E\n\u003Cp\u003EWhy going through the hassle of enabling secure boot ? Well, your root partition is safe but your kernel is not. Imagine you let your laptop unsupervised a few minutes, someone could boot from a usb and replace your kernel with a custom one without you noticing. It's something you really don't want and I don't really need to explain why.\u003C\u002Fp\u003E\n\u003Cp\u003EInstall the \u003Cem\u003Esbsigntools\u003C\u002Fem\u003E package.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003Epacman -S sbsigntools\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ECreate a new directory in a secure location like \u003Ccode\u003E\u002Froot\u002Fsecureboot\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Emkdir\u003C\u002Fspan\u003E \u002Froot\u002Fsecureboot\n\u003Cspan class=\"token builtin class-name\"\u003Ecd\u003C\u002Fspan\u003E \u002Froot\u002Fsecureboot\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch2 id=\"generate-your-own-keys\"\u003E\u003Ca href=\"#generate-your-own-keys\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EGenerate your own keys\u003C\u002Fh2\u003E\n\u003Cp\u003ECreate a script named \u003Ccode\u003Emkkeys.sh\u003C\u002Fcode\u003E that will automate the process.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-bash\"\u003E\u003Ccode class=\"language-bash\"\u003E\u003Cspan class=\"token shebang important\"\u003E#!\u002Fbin\u002Fbash\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"token builtin class-name\"\u003Eecho\u003C\u002Fspan\u003E -n \u003Cspan class=\"token string\"\u003E\"Enter a Common Name to embed in the keys: \"\u003C\u002Fspan\u003E\n\u003Cspan class=\"token builtin class-name\"\u003Eread\u003C\u002Fspan\u003E name\n\n\u003Cspan class=\"token comment\"\u003E#GUID\u003C\u002Fspan\u003E\nuuidgen --random \u003Cspan class=\"token operator\"\u003E\u003E\u003C\u002Fspan\u003E GUID.txt\n\n\u003Cspan class=\"token comment\"\u003E#PLATFORM KEY\u003C\u002Fspan\u003E\nopenssl req -newkey rsa:4096 -nodes -keyout PK.key -new -x509 -sha256 -days \u003Cspan class=\"token number\"\u003E3650\u003C\u002Fspan\u003E -subj \u003Cspan class=\"token string\"\u003E\"\u002FCN=\u003Cspan class=\"token variable\"\u003E$name\u003C\u002Fspan\u003E PK\u002F\"\u003C\u002Fspan\u003E -out PK.crt\nopenssl x509 -outform DER -in PK.crt -out PK.cer\ncert-to-efi-sig-list -g \u003Cspan class=\"token string\"\u003E\"\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E&lt;\u003C\u002Fspan\u003E GUID.txt\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\"\u003C\u002Fspan\u003E PK.crt PK.esl\nsign-efi-sig-list -g \u003Cspan class=\"token string\"\u003E\"\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E&lt;\u003C\u002Fspan\u003E GUID.txt\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\"\u003C\u002Fspan\u003E -k PK.key -c PK.crt PK PK.esl PK.auth\nsign-efi-sig-list -g \u003Cspan class=\"token string\"\u003E\"\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E&lt;\u003C\u002Fspan\u003E GUID.txt\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\"\u003C\u002Fspan\u003E -c PK.crt -k PK.key PK \u002Fdev\u002Fnull rm_PK.auth\n\n\u003Cspan class=\"token comment\"\u003E#KEY EXCHANGE KEY\u003C\u002Fspan\u003E\nopenssl req -newkey rsa:4096 -nodes -keyout KEK.key -new -x509 -sha256 -days \u003Cspan class=\"token number\"\u003E3650\u003C\u002Fspan\u003E -subj \u003Cspan class=\"token string\"\u003E\"\u002FCN=\u003Cspan class=\"token variable\"\u003E$name\u003C\u002Fspan\u003E KEK\u002F\"\u003C\u002Fspan\u003E -out KEK.crt\nopenssl x509 -outform DER -in KEK.crt -out KEK.cer\ncert-to-efi-sig-list -g \u003Cspan class=\"token string\"\u003E\"\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E&lt;\u003C\u002Fspan\u003E GUID.txt\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\"\u003C\u002Fspan\u003E KEK.crt KEK.esl\nsign-efi-sig-list -g \u003Cspan class=\"token string\"\u003E\"\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E&lt;\u003C\u002Fspan\u003E GUID.txt\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\"\u003C\u002Fspan\u003E -k PK.key -c PK.crt KEK KEK.esl KEK.auth\n\n\u003Cspan class=\"token comment\"\u003E#SIGNATURE DATABASE KEY\u003C\u002Fspan\u003E\nopenssl req -newkey rsa:4096 -nodes -keyout db.key -new -x509 -sha256 -days \u003Cspan class=\"token number\"\u003E3650\u003C\u002Fspan\u003E -subj \u003Cspan class=\"token string\"\u003E\"\u002FCN=\u003Cspan class=\"token variable\"\u003E$name\u003C\u002Fspan\u003E db\u002F\"\u003C\u002Fspan\u003E -out db.crt\nopenssl x509 -outform DER -in db.crt -out db.cer\ncert-to-efi-sig-list -g \u003Cspan class=\"token string\"\u003E\"\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E&lt;\u003C\u002Fspan\u003E GUID.txt\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\"\u003C\u002Fspan\u003E db.crt db.esl\nsign-efi-sig-list -g \u003Cspan class=\"token string\"\u003E\"\u003Cspan class=\"token variable\"\u003E\u003Cspan class=\"token variable\"\u003E$(\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E&lt;\u003C\u002Fspan\u003E GUID.txt\u003Cspan class=\"token variable\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\"\u003C\u002Fspan\u003E -k KEK.key -c KEK.crt db db.esl db.auth\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EThen execute the script.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Etouch\u003C\u002Fspan\u003E mkkeys.sh\n\u003Cspan class=\"token function\"\u003Echmod\u003C\u002Fspan\u003E +x mkkeys.sh\n.\u002Fmkkeys.sh\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch2 id=\"generate-signed-unified-kernel\"\u003E\u003Ca href=\"#generate-signed-unified-kernel\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EGenerate signed unified kernel\u003C\u002Fh2\u003E\n\u003Cp\u003ECreate a file named \u003Ccode\u003Ecmdline.txt\u003C\u002Fcode\u003E containing the kernel parameters.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token assign-left variable\"\u003EBOOT_IMAGE\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u002Fvmlinuz-linux \u003Cspan class=\"token assign-left variable\"\u003Einitrd\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u002Fintel-ucode.img \u003Cspan class=\"token assign-left variable\"\u003Einitrd\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u002Finitramfs-linux.img \u003Cspan class=\"token assign-left variable\"\u003Eroot\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u002Fdev\u002Fmapper\u002Froot\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ENotice that I'm using the \u003Ca href=\"https:\u002F\u002Fwiki.archlinux.org\u002Findex.php\u002FMicrocode#Installation\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003EIntel microcode\u003C\u002Fa\u003E. If you don't have a Intel CPU or just don't want to use it, some modifications are required.\u003C\u002Fp\u003E\n\u003Cp\u003ECreate a script named \u003Ccode\u003Emkkernel.sh\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token shebang important\"\u003E#!\u002Fbin\u002Fsh\u003C\u002Fspan\u003E\n\u003Cspan class=\"token builtin class-name\"\u003Ecd\u003C\u002Fspan\u003E \u002Froot\u002Fsecureboot\n\n\u003Cspan class=\"token comment\"\u003E#COMBINE FILES\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003Ecat\u003C\u002Fspan\u003E \u002Fboot\u002Fintel-ucode.img \u002Fboot\u002Finitramfs-linux.img \u003Cspan class=\"token operator\"\u003E\u003E\u003C\u002Fspan\u003E initramfs-linux.img\n\u003Cspan class=\"token function\"\u003Ecp\u003C\u002Fspan\u003E \u002Fboot\u002Fvmlinuz-linux \u003Cspan class=\"token builtin class-name\"\u003E.\u003C\u002Fspan\u003E\n\nobjcopy \u003Cspan class=\"token punctuation\"\u003E\\\u003C\u002Fspan\u003E\n    --add-section .osrel\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u002Fetc\u002Fos-release --change-section-vma .osrel\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E0x20000 \u003Cspan class=\"token punctuation\"\u003E\\\u003C\u002Fspan\u003E\n    --add-section .cmdline\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u003Cspan class=\"token string\"\u003E\"cmdline.txt\"\u003C\u002Fspan\u003E --change-section-vma .cmdline\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E0x30000 \u003Cspan class=\"token punctuation\"\u003E\\\u003C\u002Fspan\u003E\n    --add-section .linux\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u003Cspan class=\"token string\"\u003E\"vmlinuz-linux\"\u003C\u002Fspan\u003E --change-section-vma .linux\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E0x40000 \u003Cspan class=\"token punctuation\"\u003E\\\u003C\u002Fspan\u003E\n    --add-section .initrd\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\u003Cspan class=\"token string\"\u003E\"initramfs-linux.img\"\u003C\u002Fspan\u003E --change-section-vma .initrd\u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E0x3000000 \u003Cspan class=\"token punctuation\"\u003E\\\u003C\u002Fspan\u003E\n    \u002Fusr\u002Flib\u002Fsystemd\u002Fboot\u002Fefi\u002Flinuxx64.efi.stub kernel.efi\n\n\u003Cspan class=\"token comment\"\u003E#SIGN EFI\u003C\u002Fspan\u003E\nsbsign --key db.key --cert db.crt --output kernel.efi.signed kernel.efi\n\n\u003Cspan class=\"token comment\"\u003E#COPY KERNEL\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003Ecp\u003C\u002Fspan\u003E kernel.efi.signed \u002Fboot\u002Fkernel.efi\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EMake it executable.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-shell\"\u003E\u003Ccode class=\"language-shell\"\u003E\u003Cspan class=\"token function\"\u003Etouch\u003C\u002Fspan\u003E mkkernel.sh\n\u003Cspan class=\"token function\"\u003Echmod\u003C\u002Fspan\u003E +x mkkernel.sh\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EYou can manually execute the script each time you want to update the kernel but I recommend to automate the process with a pacman hook.\u003C\u002Fp\u003E\n\u003Cp\u003ECreate a file at \u003Ccode\u003E\u002Fetc\u002Fpacman.d\u002Fhooks\u002F91-secureboot.hook\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003E[Trigger]\nType = Path\nOperation = Install\nOperation = Upgrade\nTarget = usr\u002Flib\u002Fmodules\u002F*\u002Fvmlinuz\nTarget = usr\u002Flib\u002Finitcpio\u002F*\n\n[Action]\nDescription = Making signed kernel UEFI\nWhen = PostTransaction\nExec = \u002Froot\u002Fsecureboot\u002Fmkkernel.sh\nNeedsTargets\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch2 id=\"enroll-keys-in-firmware\"\u003E\u003Ca href=\"#enroll-keys-in-firmware\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EEnroll keys in firmware\u003C\u002Fh2\u003E\n\u003Cp\u003EI tried to use \u003Cstrong\u003Esbkeysync\u003C\u002Fstrong\u003E but despite being in setup mode, I was unable to enroll my keys so I had to enroll them manually, using my BIOS setup interface. Don't forget to enable secure boot mode in your BIOS setup interface and to lock it behind a password because if someone is able to simply turn it off, it would make all this pointless.\u003C\u002Fp\u003E\n\u003Ch2 id=\"bootloader\"\u003E\u003Ca href=\"#bootloader\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EBootloader\u003C\u002Fh2\u003E\n\u003Cp\u003EI did not install any bootloader because it's simply useless in this case. Instead go into your BIOS setup interface and make a new boot entry for \u003Ccode\u003Ekernel.efi\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\u003Ch1 id=\"recommendations\"\u003E\u003Ca href=\"#recommendations\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003ERecommendations\u003C\u002Fh1\u003E\n\u003Cul\u003E\n\u003Cli\u003EI like to use a passphrase instead of password. It may be a bit longer to enter each time but it's easier to remember and save you the trouble of having to distinguish similar letters. Also a 8 word passphrase from a dictionary of 3600 words is stronger than a 8 long password from 60 different characters (3600^8 \u003E 60^8).\u003C\u002Fli\u003E\n\u003Cli\u003EUse a idle screen locker and always lock your laptop before leaving it.\u003C\u002Fli\u003E\n\u003Cli\u003EBe aware of who might be looking at your screen\u002Fkeyboard while you enter your passphrase.\u003C\u002Fli\u003E\n\u003Cli\u003EDon't let the usb key containing the LUKS header on your laptop. Remove it after the boot process and keep it with you.\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n"}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/assets/js/app.feb235b1.js" defer></script><script src="/assets/js/page--src--templates--post-vue.1da42f01.js" defer></script>
  </body>
</html>
